<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üçΩÔ∏è Food Details - Food Ordering & Tracking</title>
    <meta name="description" content="View food details, add to cart, and order your favorite meals with real-time delivery tracking.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        h1 {
            color: #ffffff;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .food-details {
            background: #1f1f1f;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid #2d2d2d;
            padding: 20px;
            color: #ffffff;
        }

        .food-details h2 {
            color: #ffffff;
            font-weight: 600;
        }

        .food-details p {
            color: #b0b0b0;
        }

        .container {
            background: #1f1f1f;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .text-center i {
            color: #ff6b6b;
        }

        .col-md-8 {
            color: #ffffff;
        }

        .col-md-8 h3 {
            color: #ffffff;
        }

        .col-md-8 p {
            color: #b0b0b0;
        }

        .text-muted {
            color: #ffffff !important;
        }

        .modal-content {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
        }

        .modal-header {
            border-bottom: 1px solid #2d2d2d;
        }

        .modal-footer {
            border-top: 1px solid #2d2d2d;
        }

        h4 {
            color: #ffffff;
        }

        .form-label {
            color: #b0b0b0;
            font-weight: 600;
        }

        .form-control, .form-select {
            background: #2a2a2a;
            border: 2px solid #3d3d3d;
            color: #ffffff;
            border-radius: 10px;
        }

        .form-control:focus, .form-select:focus {
            background: #333333;
            border-color: #ff6b6b;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(255, 107, 107, 0.25);
        }

        .form-control::placeholder {
            color: #808080;
        }

        .btn-close {
            filter: invert(1);
        }

        .btn-primary {
            background: #ff6b6b;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #ee5a52;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .ms-2 {
            color: #b0b0b0;
        }

        .btn-secondary {
            background: #3d3d3d;
            border: none;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #4d4d4d;
            color: #ffffff;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .badge.bg-warning {
            background: #ffc107 !important;
            color: #000;
        }

        .badge.bg-info {
            background: #17a2b8 !important;
        }

        .badge.bg-success {
            background: #28a745 !important;
        }

        .badge.bg-danger {
            background: #dc3545 !important;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <!-- Navbar Container -->
    <div id="navbar"></div>

    <div class="container my-5">
        <h1 class="mb-4"><i class="bi bi-basket2-fill text-danger"></i> Food Details</h1>
        <p class="lead text-muted mb-4"><i class="bi bi-truck"></i> Order now and track your delivery with real-time GPS tracking</p>

        <!-- Food details content goes here -->
        <div class="row">
            <!-- Left Column: Food Icon and Details -->
            <div class="col-md-4">
                <div class="text-center mb-4">
                    <i class="bi bi-basket2-fill" style="font-size: 6rem; color: #ff6b6b;"></i>
                </div>
                <div class="food-details">
                    <h2 id="foodName">Food Name</h2>
                    <p><strong>Restaurant:</strong> <span id="foodRestaurant">Restaurant</span></p>
                    <p><strong>Price:</strong> $<span id="foodPrice">0.00</span></p>
                    <p><strong>Description:</strong></p>
                    <p id="foodDescription">Food description goes here.</p>
                </div>
            </div>

            <!-- Middle and Right Column -->
            <div class="col-md-8">
                <h3>Orders</h3>
                <div class="mb-3">
                    <button class="btn btn-primary me-2" 
                            data-bs-toggle="modal" 
                            data-bs-target="#createOrderModal"
                            id="addOrderButton">
                        <i class="bi bi-plus-circle me-2"></i>
                        Place Your Order
                    </button>
                    <button class="btn btn-success" 
                            onclick="addToCart()"
                            id="addToCartButton"
                            style="display: none;">
                        <i class="bi bi-cart-plus me-2"></i>
                        Add to Cart
                    </button>
                </div>
                <div id="ordersList"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi me-2" id="toastIcon"></i>
                <strong class="me-auto" id="toastTitle">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toastBody">
                Message
            </div>
        </div>
    </div>

    <!-- Add to Cart Modal -->
    <div class="modal fade" id="addToCartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Add to Cart</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="cartForm">
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="cartQuantity" min="1" value="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Special Instructions (Optional)</label>
                            <textarea class="form-control" id="cartNotes" rows="4" placeholder="Any special requests or dietary requirements..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmAddToCart()">
                        <i class="bi bi-cart-plus"></i> Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Order Modal -->
     <div class="modal fade" id="createOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Place Your Order</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="orderForm">
                        <div class="mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="orderQuantity" min="1" value="1" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Special Instructions (Optional)</label>
                            <textarea class="form-control" id="orderNotes" rows="4" placeholder="Any special requests or dietary requirements..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createOrder()">Place Order</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Show toast notification
    function showToast(title, message, type = 'info') {
        const toastEl = document.getElementById('liveToast');
        const toastTitle = document.getElementById('toastTitle');
        const toastBody = document.getElementById('toastBody');
        const toastIcon = document.getElementById('toastIcon');

        toastTitle.textContent = title;
        toastBody.textContent = message;

        // Set icon based on type
        if (type === 'success') {
            toastIcon.className = 'bi bi-check-circle-fill text-success me-2';
        } else if (type === 'error') {
            toastIcon.className = 'bi bi-exclamation-circle-fill text-danger me-2';
        } else {
            toastIcon.className = 'bi bi-info-circle-fill text-info me-2';
        }

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Fetch food details dynamically
    async function fetchFoodDetails() {
        try {
            const params = new URLSearchParams(window.location.search);
            const foodId = params.get('id');

            if (!foodId) {
                throw new Error('No food ID provided in the URL');
            }

            const response = await fetch(`/foods/${foodId}`);
            if (!response.ok) throw new Error('Failed to fetch food details');
            const food = await response.json();

            document.getElementById('foodName').textContent = food.name;
            document.getElementById('foodRestaurant').textContent = food.restaurant;
            document.getElementById('foodPrice').textContent = food.price.toFixed(2);
            document.getElementById('foodDescription').textContent = food.description;

            // Load orders for the food
            loadOrders(foodId);
        } catch (error) {
            console.error('Error fetching food details:', error);
            document.querySelector('.container').innerHTML = `
                <p class="text-center text-danger">Failed to load food details. Please try again later.</p>
            `;
        }
    }

        // Cache current user and all users to avoid repeated fetches
    let currentUser = null;
    const userCache = new Map(); // userId ‚Üí user object

    async function loadOrders(foodId) {
        try {
            // Fetch current logged-in user first
            if (!currentUser) {
                try {
                    const meRes = await fetch('/auth/me');
                    if (meRes.ok) {
                        const data = await meRes.json();
                        if (data.loggedIn && data.user) {
                            currentUser = data.user;
                        }
                    }
                } catch (e) { 
                    console.error('Error fetching current user:', e);
                }
            }

            const response = await fetch('/orders');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const allOrders = await response.json();

            // Filter orders for this food AND current user only
            const orders = allOrders.filter(o => {
                if (!o.foodId) return false;
                const orderFoodId = typeof o.foodId === 'object' ? o.foodId._id : o.foodId;
                const createdById = typeof o.createdBy === 'object' ? o.createdBy._id : o.createdBy;
                
                // Show only orders that match the food AND belong to current user
                return orderFoodId === foodId && 
                       currentUser && 
                       (createdById === currentUser._id || createdById === currentUser.id);
            });
            
            const ordersList = document.getElementById('ordersList');

            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-muted">You haven\'t placed any orders yet. Be the first to order!</p>';
                return;
            }

            // Build order HTML (all orders shown are the user's own orders)
            const orderElements = orders.map((order) => {
                let displayName = 'You';

                // Get display name from currentUser
                if (currentUser) {
                    displayName = currentUser.name || currentUser.email.split('@')[0];
                }

                const statusColors = {
                    'pending': 'warning',
                    'accepted': 'primary',
                    'preparing': 'info',
                    'ready': 'success',
                    'out_for_delivery': 'info',
                    'delivered': 'success',
                    'rejected': 'danger',
                    'cancelled': 'danger'
                };

                const statusColor = statusColors[order.status] || 'secondary';

                return `
                    <div class="mb-4 p-4 rounded" style="background: #2a2a2a; border-left: 5px solid #ff6b6b">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <p class="mb-1">
                                    <strong>Your Order</strong>
                                    <span class="badge bg-${statusColor} ms-2">${order.status.toUpperCase().replace(/_/g, ' ')}</span>
                                </p>
                                <p class="mb-2"><strong>Quantity:</strong> ${order.quantity}</p>
                                ${order.customerNotes || order.notes ? `<p class="mb-2"><strong>Notes:</strong> ${(order.customerNotes || order.notes).replace(/\n/g, '<br>')}</p>` : ''}
                                <small class="text-muted">
                                    ${new Date(order.createdAt).toLocaleString('en-US', {
                                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                                    })}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });

            ordersList.innerHTML = orderElements.join('');

        } catch (error) {
            console.error('Error loading orders:', error);
            const ordersList = document.getElementById('ordersList');
            if (ordersList) {
                ordersList.innerHTML = `<p class="text-center text-danger">Failed to load orders: ${error.message}</p>`;
            }
        }
    }

    // Create a new order
    async function createOrder() {
        try {
            // Check authentication first
            const authResponse = await fetch('/auth/me');
            if (!authResponse.ok) {
                alert('You must be logged in to place an order.');
                window.location.href = '/login';
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const foodId = params.get('id');

            if (!foodId) {
                alert('Invalid food item.');
                return;
            }

            const quantity = document.getElementById('orderQuantity').value;
            const orderNotes = document.getElementById('orderNotes').value;

            if (!quantity || quantity < 1) {
                alert('Please enter a valid quantity.');
                return;
            }

            const orderData = {
                foodId: foodId,
                quantity: parseInt(quantity),
                notes: orderNotes,
                customerNotes: orderNotes,
                status: 'pending'
            };

            const response = await fetch('/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to create order');
            }

            // Close modal and refresh orders
            const createOrderModal = bootstrap.Modal.getInstance(document.getElementById('createOrderModal'));
            if (createOrderModal) {
                createOrderModal.hide();
            }
            
            // Reset form
            document.getElementById('orderQuantity').value = 1;
            document.getElementById('orderNotes').value = '';
            
            // Show success toast
            showToast('Success!', 'Order placed successfully!', 'success');
            
            // Refresh the page to show new order
            fetchFoodDetails();
        } catch (error) {
            console.error('Error creating order:', error);
            alert('Failed to place order: ' + error.message);
        }
    }

    // Check if user is logged in and show/hide order button
    async function checkLoginAndToggleOrderButton() {
        try {
            const response = await fetch('/auth/me');
            const addOrderButton = document.getElementById('addOrderButton');
            const addToCartButton = document.getElementById('addToCartButton');
            
            if (response.ok) {
                const data = await response.json();
                if (data.loggedIn) {
                    addOrderButton.style.display = 'inline-block';
                    addToCartButton.style.display = 'inline-block';
                } else {
                    addOrderButton.style.display = 'none';
                    addToCartButton.style.display = 'none';
                }
            } else {
                addOrderButton.style.display = 'none';
                addToCartButton.style.display = 'none';
            }
        } catch (error) {
            console.error('Error checking login status:', error);
            document.getElementById('addOrderButton').style.display = 'none';
            document.getElementById('addToCartButton').style.display = 'none';
        }
    }

    // Add to cart function
    async function addToCart() {
        try {
            // Check authentication first
            const authResponse = await fetch('/auth/me');
            if (!authResponse.ok) {
                alert('You must be logged in to add items to cart.');
                window.location.href = '/login';
                return;
            }

            // Show the add to cart modal
            const addToCartModal = new bootstrap.Modal(document.getElementById('addToCartModal'));
            addToCartModal.show();
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to open cart modal');
        }
    }

    // Confirm add to cart
    async function confirmAddToCart() {
        try {
            const params = new URLSearchParams(window.location.search);
            const foodId = params.get('id');

            if (!foodId) {
                alert('Invalid food item.');
                return;
            }

            const quantity = document.getElementById('cartQuantity').value;
            const notes = document.getElementById('cartNotes').value;

            if (!quantity || quantity < 1) {
                alert('Please enter a valid quantity.');
                return;
            }

            const cartData = {
                foodId: foodId,
                quantity: parseInt(quantity),
                notes: notes
            };

            const response = await fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cartData)
            });

            const data = await response.json();

            if (!response.ok) {
                if (data.differentRestaurant) {
                    const confirmSwitch = confirm(
                        `${data.error}\n\nCurrent cart: ${data.currentRestaurant}\nNew item: ${data.newRestaurant}\n\nWould you like to clear your cart and add this item?`
                    );
                    if (confirmSwitch) {
                        // Clear cart and try again
                        await fetch('/cart/clear', { method: 'DELETE' });
                        const retryResponse = await fetch('/cart/add', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(cartData)
                        });
                        if (!retryResponse.ok) {
                            throw new Error('Failed to add item after clearing cart');
                        }
                    } else {
                        return;
                    }
                } else {
                    throw new Error(data.error || 'Failed to add to cart');
                }
            }

            // Close modal
            const addToCartModal = bootstrap.Modal.getInstance(document.getElementById('addToCartModal'));
            if (addToCartModal) {
                addToCartModal.hide();
            }
            
            // Reset form
            document.getElementById('cartQuantity').value = 1;
            document.getElementById('cartNotes').value = '';
            
            // Show success message
            showToast('Success!', 'Item added to cart!', 'success');
            
            // Update cart badge
            if (window.updateCartCount) {
                window.updateCartCount();
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('Failed to add to cart: ' + error.message);
        }
    }

    // Load navbar with auth check
    async function loadNavbar() {
        try {
            const response = await fetch('navbar.html');
            if (!response.ok) throw new Error('Failed to load navbar');
            document.getElementById('navbar').innerHTML = await response.text();
            // Check authentication after navbar loads
            if (window.checkNavbarAuth) {
                window.checkNavbarAuth();
            }
        } catch (error) {
            console.error('Error loading navbar:', error);
        }
    }

    // Initial fetch
    loadNavbar();
    fetchFoodDetails();
    checkLoginAndToggleOrderButton();

</script>

<script src="./js/checkAuth.js"></script>
</body>

</html>
