<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Food Ordering & Tracking</title>
    <meta name="description" content="Manage your profile, view order history, and track your deliveries.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ffffff;
        }

        .profile-header {
            background: #1f1f1f;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid #2d2d2d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
        }

        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #ff6b6b;
        }

        .card {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .card-title {
            color: #ffffff;
        }

        .card-text {
            color: #b0b0b0;
        }

        .btn-primary {
            background: #ff6b6b;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #ee5a52;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .form-control, .form-select {
            background: #2a2a2a;
            border: 2px solid #3d3d3d;
            color: #ffffff;
            border-radius: 10px;
        }

        .form-control:focus, .form-select:focus {
            background: #333333;
            border-color: #ff6b6b;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(255, 107, 107, 0.25);
        }

        .form-control::placeholder {
            color: #808080;
        }

        .form-label {
            color: #b0b0b0;
            font-weight: 600;
        }

        .badge {
            background: #ff6b6b;
            padding: 0.5rem 1rem;
        }

        .tab-content {
            margin-top: 2rem;
        }

        .nav-tabs {
            border-bottom: 2px solid #2d2d2d;
        }

        .nav-tabs .nav-link {
            color: #b0b0b0;
            border: none;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link.active {
            color: #ffffff;
            background: transparent;
            border-bottom: 3px solid #ff6b6b;
        }

        .food-item, .order-item {
            background: #2a2a2a;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #3d3d3d;
            color: #ffffff;
        }

        .food-item h4, .order-item h4 {
            color: #ffffff;
        }

        .food-item p, .order-item p {
            color: #b0b0b0;
        }
        
        .text-muted {
            color: #ffffff !important;
        }

        small {
            color: #ffffff;
        }

        .btn-sm {
            border: 2px solid #3d3d3d;
            background: #2a2a2a;
            color: #ffffff;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-sm:hover {
            background: #333333;
            border-color: #ff6b6b;
            color: #ffffff;
        }

        .btn-danger {
            background: #dc3545;
            border: none;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        h2, h3, h4 {
            color: #ffffff;
        }

        .modal-content {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
        }

        .modal-header {
            border-bottom: 1px solid #2d2d2d;
        }

        .modal-footer {
            border-top: 1px solid #2d2d2d;
        }

        .btn-close {
            filter: invert(1);
        }

        .btn-secondary {
            background: #3d3d3d;
            border: none;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background: #4d4d4d;
            color: #ffffff;
        }

        p {
            color: #b0b0b0;
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <div id="navbar"></div>

    <div class="container my-5">
        <!-- Profile Header -->
        <div class="profile-header text-center">
            <img id="profilePic" src="https://via.placeholder.com/100" alt="Profile" class="profile-pic mb-3">
            <h2 id="userName">Loading...</h2>
            <p id="userEmail" class="text-muted"></p>
            <p id="userRole" class="badge bg-primary"></p>
            <p id="restaurantName" class="text-muted"></p>
            <small class="text-muted d-block mt-2"><i class="bi bi-truck text-danger"></i> Track all your orders in real-time with GPS</small>
            <button class="btn btn-primary mt-3" id="addFoodBtn" data-bs-toggle="modal" data-bs-target="#createFoodModal" style="display: none;">
                <i class="bi bi-plus-circle"></i> Add New Food Item
            </button>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="foods-tab" data-bs-toggle="tab" data-bs-target="#foods" type="button">
                    <i class="bi bi-basket2-fill"></i> My Food Items
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">
                    <i class="bi bi-cart-check"></i> My Orders
                </button>
            </li>
        </ul>

        <div class="tab-content" id="profileTabContent">
            <!-- My Foods Tab -->
            <div class="tab-pane fade show active" id="foods" role="tabpanel">
                <div id="foodsList">
                    <p class="text-center text-muted">Loading your food items...</p>
                </div>
            </div>

            <!-- My Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div id="ordersList">
                    <p class="text-center text-muted">Loading your orders...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Food Modal -->
    <div class="modal fade" id="createFoodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Food Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createFoodForm">
                        <div class="alert alert-info">
                            <strong>Restaurant:</strong> <span id="modalRestaurantName"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Food Name</label>
                            <input type="text" class="form-control" id="foodName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" id="foodPrice" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="foodDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createFood()">Create Food Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Food Modal -->
    <div class="modal fade" id="updateFoodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Food Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateFoodForm">
                        <input type="hidden" id="updateFoodId">
                        <div class="alert alert-info">
                            <strong>Restaurant:</strong> <span id="updateModalRestaurantName"></span>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Food Name</label>
                            <input type="text" class="form-control" id="updateFoodName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" id="updateFoodPrice" step="0.01" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="updateFoodDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateFood()">Update Food Item</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Load navbar
        async function loadNavbar() {
            try {
                const response = await fetch('navbar.html');
                if (!response.ok) throw new Error('Failed to load navbar');
                document.getElementById('navbar').innerHTML = await response.text();
            } catch (error) {
                console.error('Error loading navbar:', error);
            }
        }

        // Load user profile
        async function loadProfile() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }
                const data = await response.json();
                const user = data.user;
                
                document.getElementById('userName').textContent = user.name || user.displayName;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRole').textContent = user.role ? user.role.toUpperCase() : 'CUSTOMER';
                
                if (user.profilePicture || user.photos) {
                    document.getElementById('profilePic').src = user.profilePicture || user.photos[0]?.value;
                }

                // Show restaurant name if merchant
                if (user.restaurantName) {
                    document.getElementById('restaurantName').textContent = `Restaurant: ${user.restaurantName}`;
                }

                // Show Add Food button only for merchants and admins
                if (user.role === 'merchant' || user.role === 'admin') {
                    document.getElementById('addFoodBtn').style.display = 'inline-block';
                    document.getElementById('modalRestaurantName').textContent = user.restaurantName || 'Not set';
                    document.getElementById('updateModalRestaurantName').textContent = user.restaurantName || 'Not set';
                    
                    // Show warning if no restaurant name set
                    if (!user.restaurantName) {
                        showAlert('Warning', 'Please contact admin to set your restaurant name before creating food items.');
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                window.location.href = '/login';
            }
        }

        // Show alert modal
        function showAlert(title, message) {
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('alertModal'));
            modal.show();
        }

        // Load user's foods
        async function loadMyFoods() {
            try {
                const response = await fetch('/foods');
                if (!response.ok) throw new Error('Failed to load food items');
                const allFoods = await response.json();
                
                const userResponse = await fetch('/auth/me');
                const userData = await userResponse.json();
                const userId = userData.user._id || userData.user.id;
                
                // Filter foods created by current user (handle both string and object IDs)
                const myFoods = allFoods.filter(food => {
                    const createdById = typeof food.createdBy === 'object' ? food.createdBy._id : food.createdBy;
                    return createdById === userId;
                });
                
                const foodsList = document.getElementById('foodsList');
                if (myFoods.length === 0) {
                    foodsList.innerHTML = '<p class="text-center text-muted">You haven\'t added any food items yet.</p>';
                    return;
                }
                
                foodsList.innerHTML = myFoods.map(food => `
                    <div class="food-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4>${food.name}</h4>
                                <p class="text-muted mb-2">${food.restaurant}</p>
                                <p class="text-success fw-bold mb-2">$${food.price.toFixed(2)}</p>
                                <p class="card-text">${food.description}</p>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-warning me-2" onclick="editFood('${food._id}', '${food.name.replace(/'/g, "\\'")}', '${food.price}', '${food.description.replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ')}')">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteFood('${food._id}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading foods:', error);
                document.getElementById('foodsList').innerHTML = '<p class="text-center text-danger">Failed to load food items.</p>';
            }
        }

        // Load user's orders
        async function loadMyOrders() {
            try {
                const response = await fetch('/orders');
                if (!response.ok) throw new Error('Failed to load orders');
                const allOrders = await response.json();
                
                const userResponse = await fetch('/auth/me');
                const userData = await userResponse.json();
                const userId = userData.user._id || userData.user.id;
                
                // Filter orders created by current user (handle both string and object IDs)
                const myOrders = allOrders.filter(order => {
                    const createdById = typeof order.createdBy === 'object' ? order.createdBy._id : order.createdBy;
                    return createdById === userId;
                });
                
                const ordersList = document.getElementById('ordersList');
                if (myOrders.length === 0) {
                    ordersList.innerHTML = '<p class="text-center text-muted">You haven\'t placed any orders yet.</p>';
                    return;
                }
                
                const statusColors = {
                    'pending': 'warning',
                    'accepted': 'primary',
                    'preparing': 'info',
                    'ready': 'success',
                    'out_for_delivery': 'info',
                    'delivered': 'success',
                    'rejected': 'danger',
                    'cancelled': 'danger'
                };
                
                ordersList.innerHTML = myOrders.map(order => {
                    // Handle populated foodId
                    const foodName = order.foodId ? (typeof order.foodId === 'object' ? order.foodId.name : 'Unknown Food') : 'Deleted Food';
                    const foodRestaurant = order.foodId && typeof order.foodId === 'object' ? order.foodId.restaurant : 'N/A';
                    const totalAmount = order.totalAmount || 0;
                    
                    // Show tracking button for active orders
                    const trackableStatuses = ['accepted', 'preparing', 'ready', 'out_for_delivery'];
                    const showTracking = trackableStatuses.includes(order.status);
                    
                    return `
                    <div class="order-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="mb-2">${foodName}</h5>
                                <p class="text-muted mb-2"><i class="bi bi-shop"></i> ${foodRestaurant}</p>
                                <div class="mb-2">
                                    <span class="badge bg-${statusColors[order.status] || 'secondary'}">${order.status.toUpperCase().replace(/_/g, ' ')}</span>
                                </div>
                                <p class="mb-2"><strong>Quantity:</strong> ${order.quantity} | <strong>Total:</strong> $${totalAmount.toFixed(2)}</p>
                                ${order.customerNotes || order.notes ? `<p class="card-text mb-2"><strong>Notes:</strong> ${order.customerNotes || order.notes}</p>` : ''}
                                <small class="text-muted"><i class="bi bi-calendar"></i> ${new Date(order.createdAt).toLocaleString()}</small>
                                ${showTracking ? `
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-primary" onclick="trackOrder('${order._id}')">
                                            <i class="bi bi-geo-alt"></i> Track Order
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order._id}')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersList').innerHTML = '<p class="text-center text-danger">Failed to load orders.</p>';
            }
        }

        // Track order
        function trackOrder(orderId) {
            window.location.href = `/order-tracking?orderId=${orderId}`;
        }

        // Create new food
        async function createFood() {
            const name = document.getElementById('foodName').value;
            const price = document.getElementById('foodPrice').value;
            const description = document.getElementById('foodDescription').value;

            if (!name || !price || !description) {
                showAlert('Error', 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch('/foods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        price: parseFloat(price),
                        description
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create food item');
                }
                
                // Close modal and refresh foods
                bootstrap.Modal.getInstance(document.getElementById('createFoodModal')).hide();
                document.getElementById('createFoodForm').reset();
                loadMyFoods();
                showAlert('Success', 'Food item created successfully!');
            } catch (error) {
                console.error('Error creating food:', error);
                showAlert('Error', error.message);
            }
        }

        // Edit food
        function editFood(id, name, price, description) {
            // Decode HTML entities
            const decodeHTML = (html) => {
                const txt = document.createElement('textarea');
                txt.innerHTML = html;
                return txt.value;
            };
            
            document.getElementById('updateFoodId').value = id;
            document.getElementById('updateFoodName').value = decodeHTML(name);
            document.getElementById('updateFoodPrice').value = price;
            document.getElementById('updateFoodDescription').value = decodeHTML(description);
            
            const modal = new bootstrap.Modal(document.getElementById('updateFoodModal'));
            modal.show();
        }

        // Update food
        async function updateFood() {
            const id = document.getElementById('updateFoodId').value;
            const name = document.getElementById('updateFoodName').value;
            const price = document.getElementById('updateFoodPrice').value;
            const description = document.getElementById('updateFoodDescription').value;

            if (!name || !price || !description) {
                showAlert('Error', 'Please fill in all fields');
                return;
            }
            
            try {
                const response = await fetch(`/foods/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name,
                        price: parseFloat(price),
                        description
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to update food item');
                }
                
                // Close modal and refresh foods
                bootstrap.Modal.getInstance(document.getElementById('updateFoodModal')).hide();
                loadMyFoods();
                showAlert('Success', 'Food item updated successfully!');
            } catch (error) {
                console.error('Error updating food:', error);
                showAlert('Error', error.message);
            }
        }

        // Delete food
        let deleteFoodId = null;
        function deleteFood(id) {
            console.log('Delete food called with ID:', id);
            deleteFoodId = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteFoodModal'));
            modal.show();
        }

        // Delete order
        let deleteOrderId = null;
        function deleteOrder(id) {
            console.log('Delete order called with ID:', id);
            deleteOrderId = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteOrderModal'));
            modal.show();
        }

        // Set up modal confirm handlers - only once
        let handlersInitialized = false;
        
        function initializeDeleteHandlers() {
            if (handlersInitialized) return;
            handlersInitialized = true;
            
            const confirmDeleteFoodBtn = document.getElementById('confirmDeleteFood');
            const confirmDeleteOrderBtn = document.getElementById('confirmDeleteOrder');
            
            if (confirmDeleteFoodBtn) {
                confirmDeleteFoodBtn.addEventListener('click', async function() {
                    console.log('Deleting food with ID:', deleteFoodId);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteFoodModal'));
                    modal.hide();
                    
                    try {
                        const response = await fetch(`/foods/${deleteFoodId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) throw new Error('Failed to delete food item');
                        
                        loadMyFoods();
                        showAlert('Success', 'Food item deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting food:', error);
                        showAlert('Error', 'Failed to delete food item');
                    }
                });
            }

            if (confirmDeleteOrderBtn) {
                confirmDeleteOrderBtn.addEventListener('click', async function() {
                    console.log('Deleting order with ID:', deleteOrderId);
                    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteOrderModal'));
                    modal.hide();
                    
                    try {
                        const response = await fetch(`/orders/${deleteOrderId}`, {
                            method: 'DELETE'
                        });
                        
                        if (!response.ok) throw new Error('Failed to delete order');
                        
                        loadMyOrders();
                        showAlert('Success', 'Order deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting order:', error);
                        showAlert('Error', 'Failed to delete order');
                    }
                });
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDeleteHandlers();
        });
        
        loadNavbar();
        loadProfile();
        loadMyFoods();
        loadMyOrders();
    </script>

    <!-- Delete Food Confirmation Modal -->
    <div class="modal fade" id="deleteFoodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this food item?</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteFood">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Order Confirmation Modal -->
    <div class="modal fade" id="deleteOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this order?</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteOrder">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success/Error Alert Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="alertModalTitle">Notification</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="alertModalMessage"></p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/checkAuth.js"></script>

</body>
</html>