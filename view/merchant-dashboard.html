    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Merchant Dashboard - Food Ordering & Tracking</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
        <style>
            body {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                min-height: 100vh;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                color: #ffffff;
            }

            .dashboard-header {
                background: #1f1f1f;
                border-radius: 20px;
                padding: 2rem;
                border: 1px solid #2d2d2d;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                margin-bottom: 2rem;
                color: #ffffff;
            }

            .dashboard-header h1 {
                color: #ffffff;
            }

            .dashboard-header p {
                color: #b0b0b0;
            }

            .stat-card {
                background: #1f1f1f;
                border: 1px solid #2d2d2d;
                border-radius: 15px;
                padding: 1.5rem;
                text-align: center;
                transition: all 0.3s ease;
                color: #ffffff;
            }

            .stat-card p {
                color: #ffffff !important;
            }

            .stat-card small {
                color: #ffffff;
            }

            .stat-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            }

            .stat-card h3 {
                font-size: 2.5rem;
                color: #ff6b6b;
                margin-bottom: 0.5rem;
            }

            .order-card {
                background: #1f1f1f;
                border: 1px solid #2d2d2d;
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 1rem;
                transition: all 0.3s ease;
                color: #ffffff;
            }

            .order-card h5 {
                color: #ffffff;
            }

            .order-card p {
                color: #ffffff;
            }

            .order-card strong {
                color: #ffffff;
            }

            .order-card .text-muted {
                color: #ffffff !important;
            }

            .order-card small {
                color: #ffffff;
            }

            .order-card:hover {
                box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
            }

            .badge {
                padding: 0.5rem 1rem;
                border-radius: 10px;
                font-weight: 600;
            }

            .badge.bg-warning {
                background: #ffc107 !important;
                color: #000;
            }

            .badge.bg-info {
                background: #17a2b8 !important;
            }

            .badge.bg-success {
                background: #28a745 !important;
            }

            .badge.bg-danger {
                background: #dc3545 !important;
            }

            .badge.bg-primary {
                background: #007bff !important;
            }

            .badge.bg-secondary {
                background: #6c757d !important;
            }

            .btn-action {
                margin: 0.25rem;
            }

            .nav-tabs {
                border-bottom: 2px solid #2d2d2d;
            }

            .nav-tabs .nav-link {
                color: #b0b0b0;
                border: none;
                padding: 1rem 1.5rem;
            }

            .nav-tabs .nav-link.active {
                color: #ffffff;
                background: transparent;
                border-bottom: 3px solid #ff6b6b;
            }

            .modal-content {
                background: #1f1f1f;
                border: 1px solid #2d2d2d;
                color: #ffffff;
            }

            .modal-header {
                border-bottom: 1px solid #2d2d2d;
                color: #ffffff;
            }

            .modal-header h4, .modal-header h5 {
                color: #ffffff;
            }

            .modal-body {
                color: #ffffff;
            }

            .modal-body p {
                color: #ffffff;
            }

            .modal-body label {
                color: #ffffff;
            }

            .modal-footer {
                border-top: 1px solid #2d2d2d;
            }

            .form-control, .form-select {
                background: #2a2a2a;
                border: 2px solid #3d3d3d;
                color: #ffffff;
                border-radius: 10px;
            }

            .form-control:focus, .form-select:focus {
                background: #333333;
                border-color: #ff6b6b;
                color: #ffffff;
                box-shadow: 0 0 0 0.25rem rgba(255, 107, 107, 0.25);
            }

            .form-label {
                color: #b0b0b0;
                font-weight: 600;
            }

            .btn-close {
                filter: invert(1);
            }

            .btn-primary {
                background: #ff6b6b;
                border: none;
            }

            .btn-primary:hover {
                background: #ee5a52;
            }

            .order-details {
                background: #2a2a2a;
                padding: 1rem;
                border-radius: 10px;
                margin-bottom: 1rem;
                color: #ffffff;
            }

            .order-details p {
                color: #ffffff;
            }

            .order-details strong {
                color: #ffffff;
            }

            .order-details small {
                color: #e0e0e0;
            }

            .order-details .text-muted {
                color: #ffffff !important;
            }

            .timeline {
                position: relative;
                padding-left: 30px;
            }

            .timeline-item {
                position: relative;
                padding-bottom: 20px;
                color: #ffffff;
            }

            .timeline-item p {
                color: #ffffff;
            }

            .timeline-item small {
                color: #b0b0b0;
            }

            .timeline-item::before {
                content: '';
                position: absolute;
                left: -22px;
                top: 5px;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                background: #ff6b6b;
            }

            .timeline-item::after {
                content: '';
                position: absolute;
                left: -17px;
                top: 17px;
                width: 2px;
                height: calc(100% - 5px);
                background: #3d3d3d;
            }

            .timeline-item:last-child::after {
                display: none;
            }

            /* Global text fixes */
            p {
                color: #ffffff;
            }

            small {
                color: #ffffff;
            }

            .text-center {
                color: #ffffff;
            }

            .dashboard-header .text-muted {
                color: #ffffff !important;
            }
        </style>
    </head>
    <body>

        <!-- Navbar -->
        <div id="navbar"></div>

        <div class="container my-5">
            <div class="dashboard-header">
                <h1><i class="bi bi-shop"></i> Merchant Dashboard</h1>
                <p class="mb-0" style="color: #b0b0b0;">Manage your orders and track performance</p>
            </div>

            <!-- Statistics -->
            <div class="row mb-4" id="statsContainer">
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <i class="bi bi-clock-history" style="font-size: 2rem; color: #ffc107;"></i>
                        <h3 id="pendingCount">0</h3>
                        <p class="text-muted mb-0">Pending Orders</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <i class="bi bi-check-circle" style="font-size: 2rem; color: #28a745;"></i>
                        <h3 id="acceptedCount">0</h3>
                        <p class="text-muted mb-0">Accepted</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <i class="bi bi-fire" style="font-size: 2rem; color: #ff6b6b;"></i>
                        <h3 id="preparingCount">0</h3>
                        <p class="text-muted mb-0">Preparing</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card">
                        <i class="bi bi-currency-dollar" style="font-size: 2rem; color: #28a745;"></i>
                        <h3 id="totalRevenue">$0</h3>
                        <p class="text-muted mb-0">Total Revenue</p>
                    </div>
                </div>
            </div>

            <!-- Orders Tabs -->
            <ul class="nav nav-tabs" id="orderTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button">
                        <i class="bi bi-clock-history"></i> Pending
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
                        <i class="bi bi-fire"></i> Active
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button">
                        <i class="bi bi-check-circle"></i> Completed
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button">
                        <i class="bi bi-list-ul"></i> All Orders
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-4" id="orderTabsContent">
                <!-- Pending Orders -->
                <div class="tab-pane fade show active" id="pending" role="tabpanel">
                    <div id="pendingOrders">
                        <p class="text-center text-muted">Loading orders...</p>
                    </div>
                </div>

                <!-- Active Orders -->
                <div class="tab-pane fade" id="active" role="tabpanel">
                    <div id="activeOrders">
                        <p class="text-center text-muted">Loading orders...</p>
                    </div>
                </div>

                <!-- Completed Orders -->
                <div class="tab-pane fade" id="completed" role="tabpanel">
                    <div id="completedOrders">
                        <p class="text-center text-muted">Loading orders...</p>
                    </div>
                </div>

                <!-- All Orders -->
                <div class="tab-pane fade" id="all" role="tabpanel">
                    <div id="allOrders">
                        <p class="text-center text-muted">Loading orders...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div class="modal fade" id="orderDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Order Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="orderDetailsBody">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Accept Order Modal -->
        <div class="modal fade" id="acceptOrderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Accept Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="acceptOrderId">
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea class="form-control" id="acceptNotes" rows="3" placeholder="Add any notes for the customer..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="confirmAcceptOrder()">
                            <i class="bi bi-check-circle"></i> Accept Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reject Order Modal -->
        <div class="modal fade" id="rejectOrderModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Reject Order</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="rejectOrderId">
                        <div class="mb-3">
                            <label class="form-label">Rejection Reason *</label>
                            <select class="form-select mb-2" id="rejectReason">
                                <option value="">Select a reason...</option>
                                <option value="Item out of stock">Item out of stock</option>
                                <option value="Restaurant too busy">Restaurant too busy</option>
                                <option value="Kitchen closed">Kitchen closed</option>
                                <option value="Ingredients unavailable">Ingredients unavailable</option>
                                <option value="Other">Other (specify below)</option>
                            </select>
                            <textarea class="form-control" id="rejectDetails" rows="3" placeholder="Additional details..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmRejectOrder()">
                            <i class="bi bi-x-circle"></i> Reject Order
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            let allOrdersData = [];

            // Load navbar
            async function loadNavbar() {
                try {
                    const response = await fetch('navbar.html');
                    if (!response.ok) throw new Error('Failed to load navbar');
                    document.getElementById('navbar').innerHTML = await response.text();
                } catch (error) {
                    console.error('Error loading navbar:', error);
                }
            }

            // Check if user is merchant
            async function checkMerchantAccess() {
                try {
                    const response = await fetch('/auth/me');
                    if (!response.ok) {
                        window.location.href = '/login';
                        return false;
                    }
                    const data = await response.json();
                    if (data.user.role !== 'merchant' && data.user.role !== 'admin') {
                        alert('Access denied. Merchant role required.');
                        window.location.href = '/';
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Error checking access:', error);
                    window.location.href = '/login';
                    return false;
                }
            }

            // Load statistics
            async function loadStats() {
                try {
                    const response = await fetch('/merchant/stats');
                    if (!response.ok) throw new Error('Failed to load stats');
                    const stats = await response.json();
                    
                    document.getElementById('pendingCount').textContent = stats.pendingOrders;
                    document.getElementById('acceptedCount').textContent = stats.acceptedOrders;
                    document.getElementById('preparingCount').textContent = stats.preparingOrders;
                    document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue}`;
                } catch (error) {
                    console.error('Error loading stats:', error);
                }
            }

            // Load all orders
            async function loadOrders() {
                try {
                    const response = await fetch('/merchant/orders');
                    if (!response.ok) throw new Error('Failed to load orders');
                    allOrdersData = await response.json();
                    
                    renderOrders();
                } catch (error) {
                    console.error('Error loading orders:', error);
                }
            }

            // Render orders based on filters
            function renderOrders() {
                const pendingOrders = allOrdersData.filter(o => o.status === 'pending');
                const activeOrders = allOrdersData.filter(o => ['accepted', 'preparing', 'ready'].includes(o.status));
                const completedOrders = allOrdersData.filter(o => ['delivered', 'cancelled', 'rejected'].includes(o.status));
                
                document.getElementById('pendingOrders').innerHTML = renderOrderList(pendingOrders, 'pending');
                document.getElementById('activeOrders').innerHTML = renderOrderList(activeOrders, 'active');
                document.getElementById('completedOrders').innerHTML = renderOrderList(completedOrders, 'completed');
                document.getElementById('allOrders').innerHTML = renderOrderList(allOrdersData, 'all');
            }

            // Render order list
            function renderOrderList(orders, type) {
                if (orders.length === 0) {
                    return '<p class="text-center">No orders found</p>';
                }

                return orders.map(order => {
                    // Handle missing or null data
                    if (!order.foodId || !order.createdBy) {
                        console.warn('Order missing required data:', order);
                        return '';
                    }

                    const statusColors = {
                        'pending': 'warning',
                        'accepted': 'primary',
                        'preparing': 'info',
                        'ready': 'success',
                        'out_for_delivery': 'info',
                        'delivered': 'success',
                        'rejected': 'danger',
                        'cancelled': 'secondary'
                    };

                    const statusColor = statusColors[order.status] || 'secondary';
                    const foodPrice = order.foodId.price || 0;
                    const totalAmount = order.totalAmount || (foodPrice * order.quantity);

                    return `
                        <div class="order-card">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="mb-1">${order.foodId.name}</h5>
                                    <p class="text-muted mb-1">
                                        <i class="bi bi-person"></i> ${order.createdBy.name}
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="bi bi-clock"></i> ${new Date(order.createdAt).toLocaleString()}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${statusColor} mb-2">${order.status.toUpperCase().replace('_', ' ')}</span>
                                    <p class="mb-0"><strong>Qty:</strong> ${order.quantity}</p>
                                    <p class="mb-0"><strong>$${totalAmount}</strong></p>
                                </div>
                            </div>
                            
                            ${order.customerNotes || order.notes ? `
                                <div class="order-details mb-3">
                                    <small class="text-muted"><i class="bi bi-chat-left-text"></i> Customer Notes:</small>
                                    <p class="mb-0">${order.customerNotes || order.notes || 'No notes'}</p>
                                </div>
                            ` : ''}

                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-info" onclick="viewOrderDetails('${order._id}')">
                                    <i class="bi bi-eye"></i> View Details
                                </button>
                                
                                ${order.status === 'pending' ? `
                                    <button class="btn btn-sm btn-success" onclick="showAcceptModal('${order._id}')">
                                        <i class="bi bi-check-circle"></i> Accept
                                    </button>
                                    <button class="btn btn-sm btn-danger" onclick="showRejectModal('${order._id}')">
                                        <i class="bi bi-x-circle"></i> Reject
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'accepted' ? `
                                    <button class="btn btn-sm btn-primary" onclick="updateOrderStatus('${order._id}', 'prepare')">
                                        <i class="bi bi-fire"></i> Start Preparing
                                    </button>
                                ` : ''}
                                
                                ${order.status === 'preparing' ? `
                                    <button class="btn btn-sm btn-success" onclick="updateOrderStatus('${order._id}', 'ready')">
                                        <i class="bi bi-check2-all"></i> Mark Ready
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // View order details
            function viewOrderDetails(orderId) {
                const order = allOrdersData.find(o => o._id === orderId);
                if (!order) return;

                const totalAmount = (order.foodId.price * order.quantity).toFixed(2);
                
                let historyHtml = '';
                if (order.statusHistory && order.statusHistory.length > 0) {
                    historyHtml = `
                        <div class="mt-4">
                            <h6>Status History</h6>
                            <div class="timeline">
                                ${order.statusHistory.map(h => `
                                    <div class="timeline-item">
                                        <strong>${h.status.toUpperCase().replace('_', ' ')}</strong>
                                        <p class="text-muted small mb-0">${new Date(h.timestamp).toLocaleString()}</p>
                                        ${h.updatedBy ? `<p class="small mb-0">By: ${h.updatedBy}</p>` : ''}
                                        ${h.notes ? `<p class="small mb-0">${h.notes}</p>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                const detailsHtml = `
                    <div class="order-details">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Food Item</h6>
                                <p><strong>${order.foodId.name}</strong></p>
                                <p class="text-muted">${order.foodId.description}</p>
                                <p><strong>Restaurant:</strong> ${order.foodId.restaurant}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Order Info</h6>
                                <p><strong>Quantity:</strong> ${order.quantity}</p>
                                <p><strong>Unit Price:</strong> $${order.foodId.price.toFixed(2)}</p>
                                <p><strong>Total Amount:</strong> $${totalAmount}</p>
                                <p><strong>Status:</strong> <span class="badge bg-info">${order.status.toUpperCase().replace('_', ' ')}</span></p>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Customer Information</h6>
                                <p><strong>Name:</strong> ${order.createdBy.name}</p>
                                <p><strong>Email:</strong> ${order.createdBy.email}</p>
                            </div>
                        </div>

                        ${order.customerNotes || order.notes ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Customer Notes</h6>
                                    <p>${order.customerNotes || order.notes}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${order.merchantNotes ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Merchant Notes</h6>
                                    <p>${order.merchantNotes}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${order.rejectionReason ? `
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Rejection Reason</h6>
                                    <p class="text-danger">${order.rejectionReason}</p>
                                </div>
                            </div>
                        ` : ''}

                        ${historyHtml}
                    </div>
                `;

                document.getElementById('orderDetailsBody').innerHTML = detailsHtml;
                new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
            }

            // Show accept modal
            function showAcceptModal(orderId) {
                document.getElementById('acceptOrderId').value = orderId;
                document.getElementById('acceptNotes').value = '';
                new bootstrap.Modal(document.getElementById('acceptOrderModal')).show();
            }

            // Confirm accept order
            async function confirmAcceptOrder() {
                const orderId = document.getElementById('acceptOrderId').value;
                const notes = document.getElementById('acceptNotes').value;

                try {
                    const response = await fetch(`/merchant/orders/${orderId}/accept`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ merchantNotes: notes })
                    });

                    if (!response.ok) throw new Error('Failed to accept order');

                    bootstrap.Modal.getInstance(document.getElementById('acceptOrderModal')).hide();
                    await loadOrders();
                    await loadStats();
                    alert('Order accepted successfully!');
                } catch (error) {
                    console.error('Error accepting order:', error);
                    alert('Failed to accept order');
                }
            }

            // Show reject modal
            function showRejectModal(orderId) {
                document.getElementById('rejectOrderId').value = orderId;
                document.getElementById('rejectReason').value = '';
                document.getElementById('rejectDetails').value = '';
                new bootstrap.Modal(document.getElementById('rejectOrderModal')).show();
            }

            // Confirm reject order
            async function confirmRejectOrder() {
                const orderId = document.getElementById('rejectOrderId').value;
                const reason = document.getElementById('rejectReason').value;
                const details = document.getElementById('rejectDetails').value;

                if (!reason) {
                    alert('Please select a rejection reason');
                    return;
                }

                const rejectionReason = reason === 'Other' ? details : `${reason}${details ? ': ' + details : ''}`;

                try {
                    const response = await fetch(`/merchant/orders/${orderId}/reject`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rejectionReason })
                    });

                    if (!response.ok) throw new Error('Failed to reject order');

                    bootstrap.Modal.getInstance(document.getElementById('rejectOrderModal')).hide();
                    await loadOrders();
                    await loadStats();
                    alert('Order rejected');
                } catch (error) {
                    console.error('Error rejecting order:', error);
                    alert('Failed to reject order');
                }
            }

            // Update order status
            async function updateOrderStatus(orderId, action) {
                try {
                    const response = await fetch(`/merchant/orders/${orderId}/${action}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) throw new Error('Failed to update order status');

                    await loadOrders();
                    await loadStats();
                    alert('Order status updated successfully!');
                } catch (error) {
                    console.error('Error updating order:', error);
                    alert('Failed to update order status');
                }
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', async function() {
                loadNavbar();
                const hasAccess = await checkMerchantAccess();
                if (hasAccess) {
                    loadStats();
                    loadOrders();
                    
                    // Refresh orders every 30 seconds
                    setInterval(() => {
                        loadOrders();
                        loadStats();
                    }, 30000);
                }
            });
        </script>

        <script src="js/checkAuth.js"></script>

    </body>
    </html>
