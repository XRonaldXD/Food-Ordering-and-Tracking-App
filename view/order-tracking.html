<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order - Food Ordering & Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #ffffff;
        }
        .tracking-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .tracking-header {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .status-timeline {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 2rem;
        }
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.65rem;
            top: 2rem;
            bottom: -1rem;
            width: 2px;
            background: rgba(255, 255, 255, 0.2);
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-icon {
            position: absolute;
            left: 0;
            top: 0;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .timeline-icon.active {
            background: linear-gradient(135deg, #4a69bd 0%, #3c5a9d 100%);
            box-shadow: 0 0 20px rgba(74, 105, 189, 0.5);
        }
        .timeline-icon.completed {
            background: #28a745;
        }
        .timeline-icon.pending {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
        }
        #map {
            height: 500px;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .driver-info {
            background: linear-gradient(135deg, rgba(74, 105, 189, 0.2) 0%, rgba(60, 90, 157, 0.2) 100%);
            border: 1px solid rgba(74, 105, 189, 0.3);
        }
        .eta-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            display: inline-block;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            display: inline-block;
        }
        .badge-pending { background: #ffc107; color: #000; }
        .badge-accepted { background: #17a2b8; }
        .badge-preparing { background: #6c757d; }
        .badge-ready { background: #28a745; }
        .badge-out_for_delivery { background: #007bff; }
        .badge-delivered { background: #28a745; }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="navbar-placeholder"></div>

    <div class="tracking-container">
        <div class="tracking-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1><i class="bi bi-geo-alt-fill text-danger"></i> Track Your Order</h1>
                    <p class="text-muted"><i class="bi bi-broadcast"></i> Real-Time GPS Tracking • Updates every 5 seconds</p>
                    <p class="mb-0" id="orderNumber"></p>
                </div>
                <div id="statusBadge"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Map -->
                <div id="map"></div>

                <!-- Status Timeline -->
                <div class="status-timeline">
                    <h3 class="mb-4">Order Status</h3>
                    <div id="timeline"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- ETA Card -->
                <div class="info-card" id="etaCard" style="display: none;">
                    <h5 class="mb-3"><i class="bi bi-clock"></i> Estimated Delivery</h5>
                    <div class="eta-badge" id="etaTime">
                        <i class="bi bi-stopwatch"></i> Calculating...
                    </div>
                </div>

                <!-- Driver Info -->
                <div class="info-card driver-info" id="driverCard" style="display: none;">
                    <h5 class="mb-3"><i class="bi bi-person-badge"></i> Your Driver</h5>
                    <p class="mb-2"><strong>Name:</strong> <span id="driverName">-</span></p>
                    <p class="mb-0"><strong>Contact:</strong> <span id="driverContact">-</span></p>
                    <div class="mt-3">
                        <span class="badge bg-info pulse">
                            <i class="bi bi-broadcast"></i> Live Tracking Active
                        </span>
                    </div>
                </div>

                <!-- Order Details -->
                <div class="info-card">
                    <h5 class="mb-3"><i class="bi bi-receipt"></i> Order Details</h5>
                    <p class="mb-2"><strong>Food:</strong> <span id="foodName">-</span></p>
                    <p class="mb-2"><strong>Restaurant:</strong> <span id="restaurant">-</span></p>
                    <p class="mb-2"><strong>Quantity:</strong> <span id="quantity">-</span></p>
                    <p class="mb-2"><strong>Amount:</strong> $<span id="amount">0.00</span></p>
                    <hr style="border-color: rgba(255, 255, 255, 0.1);">
                    <p class="mb-2"><strong>Delivery Address:</strong></p>
                    <p class="mb-0" id="deliveryAddress">-</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/checkAuth.js"></script>
    <script>
        let map;
        let driverMarker;
        let customerMarker;
        let routeLine;
        let orderId;
        let updateInterval;

        document.addEventListener('DOMContentLoaded', async () => {
            // Load navbar
            const navbarResponse = await fetch('navbar.html');
            const navbarHtml = await navbarResponse.text();
            document.getElementById('navbar-placeholder').innerHTML = navbarHtml;
            await checkAuthStatus();

            // Get order ID from URL
            const params = new URLSearchParams(window.location.search);
            orderId = params.get('orderId');

            if (!orderId) {
                alert('No order ID provided');
                window.location.href = '/profile';
                return;
            }

            // Initialize map
            initMap();

            // Load tracking data
            await loadTrackingData();

            // Start real-time updates every 5 seconds
            updateInterval = setInterval(loadTrackingData, 5000);
        });

        function initMap() {
            // Initialize map centered on a default location
            map = L.map('map').setView([1.3521, 103.8198], 13); // Singapore as default

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        async function loadTrackingData() {
            try {
                const response = await fetch(`/tracking/${orderId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    throw new Error('Failed to load tracking data');
                }

                const data = await response.json();
                updateUI(data);
                updateMap(data);
                updateTimeline(data);
            } catch (error) {
                console.error('Error loading tracking data:', error);
            }
        }

        function updateUI(data) {
            // Update header
            document.getElementById('orderNumber').textContent = `Order #${data.orderId}`;
            
            // Update status badge
            const statusColors = {
                'pending': 'badge-pending',
                'accepted': 'badge-accepted',
                'preparing': 'badge-preparing',
                'ready': 'badge-ready',
                'out_for_delivery': 'badge-out_for_delivery',
                'delivered': 'badge-delivered'
            };
            document.getElementById('statusBadge').innerHTML = `
                <span class="status-badge ${statusColors[data.status] || 'badge-pending'}">
                    ${data.status.toUpperCase().replace(/_/g, ' ')}
                </span>
            `;

            // Update order details
            document.getElementById('foodName').textContent = data.foodName;
            document.getElementById('restaurant').textContent = data.restaurant;
            document.getElementById('quantity').textContent = data.quantity;
            document.getElementById('amount').textContent = data.totalAmount?.toFixed(2) || '0.00';
            document.getElementById('deliveryAddress').textContent = data.deliveryAddress || 'Not provided';

            // Update ETA if available
            if (data.estimatedDeliveryTime) {
                const eta = new Date(data.estimatedDeliveryTime);
                const now = new Date();
                const minutesLeft = Math.max(0, Math.round((eta - now) / 60000));
                
                document.getElementById('etaCard').style.display = 'block';
                document.getElementById('etaTime').innerHTML = `
                    <i class="bi bi-stopwatch"></i> ${minutesLeft} mins
                `;
            }

            // Update driver info if available
            if (data.driver && data.status === 'out_for_delivery') {
                document.getElementById('driverCard').style.display = 'block';
                document.getElementById('driverName').textContent = data.driver.name;
                document.getElementById('driverContact').textContent = data.driver.phone || 'Contact through app';
            }
        }

        function updateMap(data) {
            // Clear existing markers and lines
            if (driverMarker) map.removeLayer(driverMarker);
            if (customerMarker) map.removeLayer(customerMarker);
            if (routeLine) map.removeLayer(routeLine);

            const markers = [];

            // Add delivery location marker (customer)
            if (data.deliveryLocation && data.deliveryLocation.latitude) {
                const customerIcon = L.divIcon({
                    html: '<i class="bi bi-house-fill" style="font-size: 24px; color: #28a745;"></i>',
                    className: 'custom-marker',
                    iconSize: [30, 30]
                });

                customerMarker = L.marker(
                    [data.deliveryLocation.latitude, data.deliveryLocation.longitude],
                    { icon: customerIcon }
                ).addTo(map);
                
                customerMarker.bindPopup(`
                    <strong>Delivery Location</strong><br>
                    ${data.deliveryAddress || 'Your Address'}
                `);

                markers.push([data.deliveryLocation.latitude, data.deliveryLocation.longitude]);
            }

            // Add driver location marker if available and out for delivery
            if (data.driverLocation && data.driverLocation.latitude && data.status === 'out_for_delivery') {
                const driverIcon = L.divIcon({
                    html: '<i class="bi bi-truck" style="font-size: 24px; color: #007bff;"></i>',
                    className: 'custom-marker pulse',
                    iconSize: [30, 30]
                });

                driverMarker = L.marker(
                    [data.driverLocation.latitude, data.driverLocation.longitude],
                    { icon: driverIcon }
                ).addTo(map);

                const lastUpdated = new Date(data.driverLocation.lastUpdated);
                driverMarker.bindPopup(`
                    <strong>Driver Location</strong><br>
                    ${data.driver?.name || 'Driver'}<br>
                    <small>Updated: ${lastUpdated.toLocaleTimeString()}</small>
                `);

                markers.push([data.driverLocation.latitude, data.driverLocation.longitude]);

                // Draw line between driver and customer
                if (customerMarker) {
                    routeLine = L.polyline([
                        [data.driverLocation.latitude, data.driverLocation.longitude],
                        [data.deliveryLocation.latitude, data.deliveryLocation.longitude]
                    ], {
                        color: '#007bff',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '10, 10'
                    }).addTo(map);
                }
            }

            // Fit map to show all markers
            if (markers.length > 0) {
                if (markers.length === 1) {
                    map.setView(markers[0], 15);
                } else {
                    map.fitBounds(markers, { padding: [50, 50] });
                }
            }
        }

        function updateTimeline(data) {
            const statuses = [
                { key: 'pending', label: 'Order Placed', icon: 'bi-cart-check', time: data.createdAt },
                { key: 'accepted', label: 'Order Accepted', icon: 'bi-check-circle', time: data.acceptedAt },
                { key: 'preparing', label: 'Preparing Food', icon: 'bi-fire', time: null },
                { key: 'ready', label: 'Ready for Pickup', icon: 'bi-box-seam', time: data.readyAt },
                { key: 'out_for_delivery', label: 'Out for Delivery', icon: 'bi-truck', time: data.pickedUpAt },
                { key: 'delivered', label: 'Delivered', icon: 'bi-check2-all', time: data.deliveredAt }
            ];

            const currentStatusIndex = statuses.findIndex(s => s.key === data.status);
            
            let timelineHtml = '';
            statuses.forEach((status, index) => {
                let iconClass = 'pending';
                if (index < currentStatusIndex) {
                    iconClass = 'completed';
                } else if (index === currentStatusIndex) {
                    iconClass = 'active';
                }

                const timeStr = status.time ? 
                    `<small class="text-muted">${new Date(status.time).toLocaleString()}</small>` : '';

                timelineHtml += `
                    <div class="timeline-item">
                        <div class="timeline-icon ${iconClass}">
                            <i class="${status.icon}"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">${status.label}</h6>
                            ${timeStr}
                        </div>
                    </div>
                `;
            });

            document.getElementById('timeline').innerHTML = timelineHtml;
        }

        // Clean up interval when leaving page
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
