<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Food Ordering & Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #ffffff;
        }

        .dashboard-header {
            background: #1f1f1f;
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid #2d2d2d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            border: none;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .stat-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .stat-card.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .stat-card p {
            margin-bottom: 0;
            opacity: 0.9;
        }

        .data-table {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
            border-radius: 15px;
            padding: 1.5rem;
            overflow-x: auto;
        }

        .table {
            color: #ffffff;
        }

        .table thead {
            border-bottom: 2px solid #3d3d3d;
        }

        .table tbody tr {
            border-bottom: 1px solid #2d2d2d;
        }

        .table tbody tr:hover {
            background: #2a2a2a;
        }

        .badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
        }

        .nav-tabs {
            border-bottom: 2px solid #2d2d2d;
        }

        .nav-tabs .nav-link {
            color: #b0b0b0;
            border: none;
            padding: 1rem 1.5rem;
        }

        .nav-tabs .nav-link.active {
            color: #ffffff;
            background: transparent;
            border-bottom: 3px solid #667eea;
        }

        .modal-content {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
        }

        .modal-header {
            border-bottom: 1px solid #2d2d2d;
        }

        .modal-footer {
            border-top: 1px solid #2d2d2d;
        }

        .form-control, .form-select {
            background: #2a2a2a;
            border: 2px solid #3d3d3d;
            color: #ffffff;
            border-radius: 10px;
        }

        .form-control:focus, .form-select:focus {
            background: #333333;
            border-color: #667eea;
            color: #ffffff;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }

        .form-label {
            color: #b0b0b0;
            font-weight: 600;
        }

        .btn-close {
            filter: invert(1);
        }

        .btn-primary {
            background: #667eea;
            border: none;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .search-box {
            background: #2a2a2a;
            border: 2px solid #3d3d3d;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: #ffffff;
            width: 100%;
            max-width: 400px;
        }

        .search-box:focus {
            border-color: #667eea;
            outline: none;
        }

        .action-btn {
            margin: 0.2rem;
        }

        .chart-container {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .recent-activity {
            background: #1f1f1f;
            border: 1px solid #2d2d2d;
            border-radius: 15px;
            padding: 1.5rem;
        }

        .activity-item {
            padding: 1rem;
            border-bottom: 1px solid #2d2d2d;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .role-customer { background: #17a2b8; }
        .role-merchant { background: #fd7e14; }
        .role-driver { background: #28a745; }
        .role-admin { background: #dc3545; }
    </style>
</head>
<body>

    <!-- Navbar -->
    <div id="navbar"></div>

    <div class="container-fluid my-5">
        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-shield-check"></i> Admin Dashboard</h1>
                    <p class="text-muted mb-0">System-wide management and analytics</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshAllData()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="row mb-4" id="statsContainer">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card">
                    <i class="bi bi-people-fill" style="font-size: 2rem;"></i>
                    <h3 id="totalUsers">0</h3>
                    <p>Total Users</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card success">
                    <i class="bi bi-receipt" style="font-size: 2rem;"></i>
                    <h3 id="totalOrders">0</h3>
                    <p>Total Orders</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card warning">
                    <i class="bi bi-basket2-fill" style="font-size: 2rem;"></i>
                    <h3 id="totalFoods">0</h3>
                    <p>Food Items</p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="stat-card info">
                    <i class="bi bi-currency-dollar" style="font-size: 2rem;"></i>
                    <h3 id="totalRevenue">$0</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
        </div>

        <!-- Secondary Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="data-table text-center">
                    <h5><i class="bi bi-person"></i> Customers</h5>
                    <h3 id="customerCount" class="text-info">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="data-table text-center">
                    <h5><i class="bi bi-shop"></i> Merchants</h5>
                    <h3 id="merchantCount" class="text-warning">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="data-table text-center">
                    <h5><i class="bi bi-truck"></i> Drivers</h5>
                    <h3 id="driverCount" class="text-success">0</h3>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="data-table text-center">
                    <h5><i class="bi bi-clock-history"></i> Pending Orders</h5>
                    <h3 id="pendingOrdersCount" class="text-danger">0</h3>
                </div>
            </div>
        </div>

        <!-- Management Tabs -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                    <i class="bi bi-people"></i> Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button">
                    <i class="bi bi-receipt"></i> Orders
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="foods-tab" data-bs-toggle="tab" data-bs-target="#foods" type="button">
                    <i class="bi bi-basket2"></i> Food Items
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button">
                    <i class="bi bi-graph-up"></i> Analytics
                </button>
            </li>
        </ul>

        <div class="tab-content mt-4" id="adminTabsContent">
            <!-- Users Management -->
            <div class="tab-pane fade show active" id="users" role="tabpanel">
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-people"></i> User Management</h4>
                        <input type="text" class="search-box" id="userSearch" placeholder="Search users...">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Restaurant</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Orders Management -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-receipt"></i> Order Management</h4>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="orderStatusFilter" style="width: auto;">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="accepted">Accepted</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="out_for_delivery">Out for Delivery</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <input type="text" class="search-box" id="orderSearch" placeholder="Search orders...">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Food Item</th>
                                    <th>Restaurant</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Foods Management -->
            <div class="tab-pane fade" id="foods" role="tabpanel">
                <div class="data-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-basket2"></i> Food Items Management</h4>
                        <input type="text" class="search-box" id="foodSearch" placeholder="Search food items...">
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Restaurant</th>
                                    <th>Price</th>
                                    <th>Created By</th>
                                    <th>Date Added</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="foodsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics -->
            <div class="tab-pane fade" id="analytics" role="tabpanel">
                <div class="row">
                    <div class="col-md-8">
                        <div class="chart-container">
                            <h4><i class="bi bi-graph-up"></i> Orders & Revenue Trend</h4>
                            <canvas id="ordersChart" height="100"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="recent-activity">
                            <h5><i class="bi bi-clock-history"></i> Recent Activity</h5>
                            <div id="recentActivity">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="data-table">
                            <h5><i class="bi bi-trophy"></i> Top Food Items</h5>
                            <div id="topFoods">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="data-table">
                            <h5><i class="bi bi-star"></i> Top Merchants</h5>
                            <div id="topMerchants">
                                <p class="text-muted">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Role Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <input type="text" class="form-control" id="editUserName" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="editUserRole">
                            <option value="customer">Customer</option>
                            <option value="merchant">Merchant</option>
                            <option value="driver">Driver</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3" id="restaurantNameGroup" style="display: none;">
                        <label class="form-label">Restaurant Name</label>
                        <input type="text" class="form-control" id="editRestaurantName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUserRole()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Order Status Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editOrderId">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="editOrderStatus">
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="out_for_delivery">Out for Delivery</option>
                            <option value="delivered">Delivered</option>
                            <option value="rejected">Rejected</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="editOrderNotes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveOrderStatus()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let allUsers = [];
        let allOrders = [];
        let allFoods = [];
        let ordersChart = null;

        // Load navbar
        async function loadNavbar() {
            try {
                const response = await fetch('navbar.html');
                if (!response.ok) throw new Error('Failed to load navbar');
                document.getElementById('navbar').innerHTML = await response.text();
            } catch (error) {
                console.error('Error loading navbar:', error);
            }
        }

        // Check admin access
        async function checkAdminAccess() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return false;
                }
                const data = await response.json();
                if (data.user.role !== 'admin') {
                    alert('Access denied. Admin role required.');
                    window.location.href = '/';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error checking access:', error);
                window.location.href = '/login';
                return false;
            }
        }

        // Load system statistics
        async function loadStats() {
            try {
                const response = await fetch('/admin/stats');
                if (!response.ok) throw new Error('Failed to load stats');
                const stats = await response.json();
                
                document.getElementById('totalUsers').textContent = stats.users.total;
                document.getElementById('totalOrders').textContent = stats.orders.total;
                document.getElementById('totalFoods').textContent = stats.foods.total;
                document.getElementById('totalRevenue').textContent = `$${stats.revenue.total}`;
                
                document.getElementById('customerCount').textContent = stats.users.customers;
                document.getElementById('merchantCount').textContent = stats.users.merchants;
                document.getElementById('driverCount').textContent = stats.users.drivers;
                document.getElementById('pendingOrdersCount').textContent = stats.orders.pending;

                // Display recent activity
                displayRecentActivity(stats.recentActivity);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Display recent activity
        function displayRecentActivity(activity) {
            const container = document.getElementById('recentActivity');
            if (!activity.orders || activity.orders.length === 0) {
                container.innerHTML = '<p class="text-muted">No recent activity</p>';
                return;
            }

            container.innerHTML = activity.orders.map(order => `
                <div class="activity-item">
                    <small class="text-muted">${new Date(order.createdAt).toLocaleString()}</small>
                    <p class="mb-0"><strong>${order.createdBy.name}</strong> ordered <strong>${order.foodId.name}</strong></p>
                    <span class="badge bg-${getStatusColor(order.status)}">${order.status}</span>
                </div>
            `).join('');
        }

        // Load all users
        async function loadUsers() {
            try {
                const response = await fetch('/admin/users');
                if (!response.ok) throw new Error('Failed to load users');
                allUsers = await response.json();
                renderUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge role-${user.role}">${user.role.toUpperCase()}</span></td>
                    <td>${user.restaurantName || '-'}</td>
                    <td>
                        <span class="badge ${user.isActive ? 'bg-success' : 'bg-secondary'}">
                            ${user.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary action-btn" onclick="editUser('${user._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm ${user.isActive ? 'btn-warning' : 'btn-success'} action-btn" 
                                onclick="toggleUserStatus('${user._id}')">
                            <i class="bi bi-${user.isActive ? 'pause' : 'play'}-circle"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteUser('${user._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load all orders
        async function loadOrders() {
            try {
                const response = await fetch('/admin/orders');
                if (!response.ok) throw new Error('Failed to load orders');
                allOrders = await response.json();
                renderOrders(allOrders);
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Failed to load orders</td></tr>';
            }
        }

        // Render orders table
        function renderOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No orders found</td></tr>';
                return;
            }

            tbody.innerHTML = orders.map(order => `
                <tr>
                    <td><small>${order._id.substring(0, 8)}...</small></td>
                    <td>${order.createdBy.name}</td>
                    <td>${order.foodId.name}</td>
                    <td>${order.foodId.restaurant}</td>
                    <td>${order.quantity}</td>
                    <td>$${(order.totalAmount || 0).toFixed(2)}</td>
                    <td><span class="badge bg-${getStatusColor(order.status)}">${order.status.toUpperCase().replace('_', ' ')}</span></td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-info action-btn" onclick="editOrder('${order._id}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteOrder('${order._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load all foods
        async function loadFoods() {
            try {
                const response = await fetch('/admin/foods');
                if (!response.ok) throw new Error('Failed to load foods');
                allFoods = await response.json();
                renderFoods(allFoods);
            } catch (error) {
                console.error('Error loading foods:', error);
                document.getElementById('foodsTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load food items</td></tr>';
            }
        }

        // Render foods table
        function renderFoods(foods) {
            const tbody = document.getElementById('foodsTableBody');
            if (foods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No food items found</td></tr>';
                return;
            }

            tbody.innerHTML = foods.map(food => `
                <tr>
                    <td>${food.name}</td>
                    <td>${food.restaurant}</td>
                    <td>$${food.price.toFixed(2)}</td>
                    <td>${food.createdBy ? food.createdBy.name : 'N/A'}</td>
                    <td>${new Date(food.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-danger action-btn" onclick="deleteFood('${food._id}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Load analytics
        async function loadAnalytics() {
            try {
                const response = await fetch('/admin/analytics?period=30');
                if (!response.ok) throw new Error('Failed to load analytics');
                const analytics = await response.json();
                
                renderOrdersChart(analytics.ordersOverTime);
                renderTopFoods(analytics.topFoods);
                renderTopMerchants(analytics.topMerchants);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Render orders chart
        function renderOrdersChart(data) {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            
            if (ordersChart) {
                ordersChart.destroy();
            }

            ordersChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d._id).toLocaleDateString()),
                    datasets: [{
                        label: 'Orders',
                        data: data.map(d => d.count),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Revenue ($)',
                        data: data.map(d => d.revenue),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#b0b0b0' },
                            grid: { color: '#2d2d2d' }
                        },
                        x: {
                            ticks: { color: '#b0b0b0' },
                            grid: { color: '#2d2d2d' }
                        }
                    }
                }
            });
        }

        // Render top foods
        function renderTopFoods(foods) {
            const container = document.getElementById('topFoods');
            if (!foods || foods.length === 0) {
                container.innerHTML = '<p class="text-muted">No data available</p>';
                return;
            }

            container.innerHTML = `
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Food</th>
                            <th>Restaurant</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${foods.map(food => `
                            <tr>
                                <td>${food.name}</td>
                                <td>${food.restaurant}</td>
                                <td>${food.orderCount}</td>
                                <td>$${(food.revenue || 0).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Render top merchants
        function renderTopMerchants(merchants) {
            const container = document.getElementById('topMerchants');
            if (!merchants || merchants.length === 0) {
                container.innerHTML = '<p class="text-muted">No data available</p>';
                return;
            }

            container.innerHTML = `
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Merchant</th>
                            <th>Restaurant</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${merchants.map(merchant => `
                            <tr>
                                <td>${merchant.merchantName}</td>
                                <td>${merchant.restaurantName || 'N/A'}</td>
                                <td>${merchant.totalOrders}</td>
                                <td>$${(merchant.totalRevenue || 0).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Edit user
        function editUser(userId) {
            const user = allUsers.find(u => u._id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user._id;
            document.getElementById('editUserName').value = user.name;
            document.getElementById('editUserRole').value = user.role;
            document.getElementById('editRestaurantName').value = user.restaurantName || '';
            
            if (user.role === 'merchant') {
                document.getElementById('restaurantNameGroup').style.display = 'block';
            }

            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        // Handle role change
        document.getElementById('editUserRole').addEventListener('change', function() {
            if (this.value === 'merchant') {
                document.getElementById('restaurantNameGroup').style.display = 'block';
            } else {
                document.getElementById('restaurantNameGroup').style.display = 'none';
            }
        });

        // Save user role
        async function saveUserRole() {
            const userId = document.getElementById('editUserId').value;
            const role = document.getElementById('editUserRole').value;
            const restaurantName = document.getElementById('editRestaurantName').value;

            try {
                const response = await fetch(`/admin/users/${userId}/role`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role, restaurantName })
                });

                if (!response.ok) throw new Error('Failed to update user role');

                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                await loadUsers();
                await loadStats();
                alert('User role updated successfully!');
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('Failed to update user role');
            }
        }

        // Toggle user status
        async function toggleUserStatus(userId) {
            if (!confirm('Are you sure you want to change this user\'s status?')) return;

            try {
                const response = await fetch(`/admin/users/${userId}/toggle-status`, {
                    method: 'PUT'
                });

                if (!response.ok) throw new Error('Failed to toggle user status');

                await loadUsers();
                alert('User status updated!');
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('Failed to update user status');
            }
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete user');

                await loadUsers();
                await loadStats();
                alert('User deleted successfully!');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }

        // Edit order
        function editOrder(orderId) {
            const order = allOrders.find(o => o._id === orderId);
            if (!order) return;

            document.getElementById('editOrderId').value = order._id;
            document.getElementById('editOrderStatus').value = order.status;
            document.getElementById('editOrderNotes').value = '';

            new bootstrap.Modal(document.getElementById('editOrderModal')).show();
        }

        // Save order status
        async function saveOrderStatus() {
            const orderId = document.getElementById('editOrderId').value;
            const status = document.getElementById('editOrderStatus').value;
            const notes = document.getElementById('editOrderNotes').value;

            try {
                const response = await fetch(`/admin/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, notes })
                });

                if (!response.ok) throw new Error('Failed to update order status');

                bootstrap.Modal.getInstance(document.getElementById('editOrderModal')).hide();
                await loadOrders();
                await loadStats();
                alert('Order status updated successfully!');
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status');
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;

            try {
                const response = await fetch(`/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete order');

                await loadOrders();
                await loadStats();
                alert('Order deleted successfully!');
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Failed to delete order');
            }
        }

        // Delete food
        async function deleteFood(foodId) {
            if (!confirm('Are you sure you want to delete this food item?')) return;

            try {
                const response = await fetch(`/admin/foods/${foodId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete food item');

                await loadFoods();
                await loadStats();
                alert('Food item deleted successfully!');
            } catch (error) {
                console.error('Error deleting food:', error);
                alert('Failed to delete food item');
            }
        }

        // Get status color
        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'accepted': 'primary',
                'preparing': 'info',
                'ready': 'success',
                'out_for_delivery': 'info',
                'delivered': 'success',
                'rejected': 'danger',
                'cancelled': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        // Search filters
        document.getElementById('userSearch').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.name.toLowerCase().includes(term) || 
                u.email.toLowerCase().includes(term)
            );
            renderUsers(filtered);
        });

        document.getElementById('orderSearch').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const filtered = allOrders.filter(o => 
                o.createdBy.name.toLowerCase().includes(term) || 
                o.foodId.name.toLowerCase().includes(term)
            );
            renderOrders(filtered);
        });

        document.getElementById('orderStatusFilter').addEventListener('change', function() {
            const status = this.value;
            const filtered = status ? allOrders.filter(o => o.status === status) : allOrders;
            renderOrders(filtered);
        });

        document.getElementById('foodSearch').addEventListener('input', function() {
            const term = this.value.toLowerCase();
            const filtered = allFoods.filter(f => 
                f.name.toLowerCase().includes(term) || 
                f.restaurant.toLowerCase().includes(term)
            );
            renderFoods(filtered);
        });

        // Refresh all data
        async function refreshAllData() {
            await Promise.all([
                loadStats(),
                loadUsers(),
                loadOrders(),
                loadFoods(),
                loadAnalytics()
            ]);
            alert('Data refreshed!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            loadNavbar();
            const hasAccess = await checkAdminAccess();
            if (hasAccess) {
                await loadStats();
                await loadUsers();
                await loadOrders();
                await loadFoods();
                await loadAnalytics();
            }
        });
    </script>

    <script src="js/checkAuth.js"></script>

</body>
</html>
